---
layout: post
title: Проблемы с загрузкой ОС (disk/CLASSPNP.SYS)
---

## Интро

На работе, в одном из филиалов, перестал грузится системник с ОС на базе Windows 7. Я, на всякий случай, у себя по месту раскатал образ Acronis на чистый жесткий и поехал на следующий день на место.

## Неожиданности

Как обычно, по месту все пошло не так (иначе этой записи бы не было :smile: ). На текущем жестком была побита MBR запись. Я её востановил, загрузился и остановился на черном экране системы с одним курсором. Что ж, пора было применить мой жесткий. С него я не загрузился, потому что система была раскатана под UEFI, не простой Legacy BIOS.

Ну, раз BIOS так не умеет, делаю преобразование/конвертирование типа диска с GPT в MBR. Чтобы не потерять текущуие данные, воспользовался LiveUSB с программой EaseUS Partition Master:

![EaseUS Partition Master конвертирование GPT в MBR](/assets/images/classpnp/easeus.jpg "EaseUS Partition Master конвертирование GPT в MBR")

Преобразование прошло успешно, но загрузиться я все равно не смог. Начал проверку системных файлов, но и это не помогло:

![проверка](/assets/images/classpnp/repair.jpg "проверка")

Пробую грузиться в безпоасном режиме, чтобы посмотреть, на каком этапе я торможусь:

![disk.sys и CLASSPNP.SYS](/assets/images/classpnp/classpnp.jpg "disk.sys и CLASSPNP.SYS")

Судя по загрузке, на этом этапе у меня и падает система. Гуглю решения проблем - ничего путного, кроме проверить файлы драйверов и все в таком духе. Меня смутил биос платы, так в разделе `Advanced` в пункте SATA Mode были только Disabled и IDE Mode. А раз мой образ был под UEFI, то там точно стоял AHCI Mode.

Вскрываю системный блок, очищаю от пыли, смотрю название материнской платы - [MSI H61M-P33 (B3)](https://ru.msi.com/Motherboard/H61MP33_B3/Specification). Гуглю официальную страницу, смотрю последние версии [BIOS] (https://ru.msi.com/Motherboard/H61MP33_B3/support), спецификацию платы. Плата умеет в AHCI, но в данной версии у меня этого почему-то нет. Благо на месте имеется второй системник с таким же железом, но с рабочей ОС, поэтому скачиваю exeшник и начинаю обновлять BIOS.

![Утилита для обновления BIOS](/assets/images/classpnp/biosutility.jpg "Утилита для обновления BIOS")

Ждем распаковки на флешку - обязательно запускать с неё же, иначе exeшник тупо не запустится. Система перезапустится, биос два раза попытается стартануть, но перезагрузится. А после появится черное окно с обновлением:

![Black update screen BIOS](/assets/images/classpnp/updatebios.jpg "Black update screen BIOS")

Захожу в BIOS и что я вижу - новый пункт в меню:

![AHCI Mode](/assets/images/classpnp/newmode.jpg "AHCI Mode")

Гружусь в систему (с которой обновлял BIOS) и при старте появляются новые устройства:

![Новые устройства и драйвера](/assets/images/classpnp/newdrivers.jpg "Новые устройства и драйвера")

Переставляю жесткий диск с моей системой, который не стартовал на этой системе и что вы думаете? Заработало! Почему я сразу не обновил BIOS - это другой вопрос, но после этого система загрузилась, оставалось только подкинуть драйвера под это железо и можно пользоваться системой.

## Итог

Иногда даже простое обновление BIOS помогает решить "нерешаемую" проблему.


## Случай 2

В целом, предыстория осталась примерно такой же, но на этот раз образ раскатывался на железо, отличное от того, с чего снимался образ.
Тут мне помог уже [Acronis Universal Restore](https://www.acronis.com/ru-ru/support/documentation/ATI2023/index.html#cshid=32449) - после него система продолжила загружаться, а до этого отправлялась в перезагрузку на этапе загрузке драйвера CLASSPNP.SYS. 